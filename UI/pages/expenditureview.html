<!DOCTYPE html>
<html lang="en">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta name="description" content="Frest admin is super flexible, powerful, clean &amp; modern responsive bootstrap 4 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, Frest admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="PIXINVENT">
    <title>Reports</title>
    <link rel="apple-touch-icon" href="../../app-assets/images/ico/apple-icon-120.png">
    <link rel="shortcut icon" type="image/x-icon" href="../../app-assets/images/ico/favicon.ico">
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,600%7CIBM+Plex+Sans:300,400,500,600,700" rel="stylesheet">


    <link rel="stylesheet" type="text/css" href="../../app-assets/vendors/css/vendors.min.css">
    <link rel="stylesheet" type="text/css" href="../../app-assets/vendors/css/charts/apexcharts.css">
    <link rel="stylesheet" type="text/css" href="../../app-assets/vendors/css/extensions/swiper.min.css">
    <link rel="stylesheet" href="../css/font-awesome-4.7.0/css/font-awesome.min.css">



    <link rel="stylesheet" type="text/css" href="../../app-assets/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../app-assets/css/bootstrap-extended.css">
    <link rel="stylesheet" type="text/css" href="../../app-assets/css/colors.css">
    <link rel="stylesheet" type="text/css" href="../../app-assets/css/components.css">


    <link rel="stylesheet" type="text/css" href="../../app-assets/css/core/menu/menu-types/horizontal-menu.css">
    <link rel="stylesheet" type="text/css" href="../../app-assets/css/pages/dashboard-ecommerce.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons " rel="stylesheet ">




    <link rel="icon" href="../img/core-img/favicon.png" />


    <link rel="stylesheet" href="../css/responsive.css" />

    <link rel="stylesheet" type="text/css" href="../../css/custom.css" />


    <script src="../js/modernizr.js"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-analytics.js"></script>

    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "AIzaSyAaX52IZbaEg3gYnMeHRWh5bi-pLEw2-c4",
            authDomain: "sanathana-1558e.firebaseapp.com",
            projectId: "sanathana-1558e",
            storageBucket: "sanathana-1558e.appspot.com",
            messagingSenderId: "69696836774",
            appId: "1:69696836774:web:4edf184e3cfe3608679067",
            measurementId: "G-DRHZRFBMLY"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
    </script>
    <style>
        .radio label::before{
            background-color: #fff;
        }
        
        .row{
            margin: 0;
        }
        .report-cards{
            height: 86vh;
            overflow: scroll;
        }
        .report-cards::-webkit-scrollbar{
            display: none;
        }
        
    </style>
</head>

 <body class="bg-grey">

    <!-- ***** Header Area Start ***** -->
    <!-- <section> -->
        <dvi id="navbar-container">

        </dvi>
        <div class=" row p-1" style="position: fixed;bottom:0;z-index: 999999;">
            <div class="col toast-container">
                
            </div>
        </div>
    <!-- </section> -->

    <section>
        <div class="container-fluid bg-white float-left" style="width:100% !important;">
            
            
        </div>
    </section>
    <div class="main-section ml-4 mr-4" style="padding-top: 5%;">
        <div class="row justify-content-center py-3">
            <h1 class="display-4 text-bold-600 primary">
                Reports
            </h1>
        </div> 
        <div class="row">
            <div class="col-md-4" >
                <div class="side-bar card bg-primary" style="height: 100vh;">
                    <div class="card-body">
                        <div class="card-header">
                            <div class="row chip-success chip">
                                <div class="avatar bg-success " style="padding-top : 0.3rem">
                                    <span class="material-icons " >
                                        summarize
                                    </span>
                                </div>
                                <div class="chip-body">
                                    <span class="chip-text text-bold-500" style="font-size: 1.5rem; padding: .4rem;">
                                        Available Reports
                                    </span>
                                </div>
                                
                            </div>
                        </div>
                        <div class="col text-white" id="menuContainer">
                            <a href="" class="btn btn-warning">No menu available</a>
                        </div>
                        
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="search-bar">
                    <div class="card">
                        <div class="row card-body justify-content-between">
                            <div class="col-8">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="month" class="form-control" name="" id="date">
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-control" id="active">
                                            <option>Active</option>
                                            <option>Inactive</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="row justify-content-end">
                                    <div class="col" id="newbtn">
                                        <a href="./expenditureForm.html?action=add&">
                                            <button type="button" class="btn btn-primary mr-1" id="leftmenuvalue">no data</button>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <div class="report-cards">
                    
                    
                </div>               
            </div>
        </div>
        
       
        
    </div>
    <!-- ***** Footer Area End ***** -->
    <!-- Start of Async Drift Code -->
    <script>
        "use strict";

        !(function() {
            var t = (window.driftt = window.drift = window.driftt || []);
            if (!t.init) {
                if (t.invoked) return void(window.console && console.error && console.error("Drift snippet included twice."));
                (t.invoked = !0),
                (t.methods = ["identify", "config", "track", "reset", "debug", "show", "ping", "page", "hide", "off", "on"]),
                (t.factory = function(e) {
                    return function() {
                        var n = Array.prototype.slice.call(arguments);
                        return n.unshift(e), t.push(n), t;
                    };
                }),
                t.methods.forEach(function(e) {
                        t[e] = t.factory(e);
                    }),
                    (t.load = function(t) {
                        var e = 3e5,
                            n = Math.ceil(new Date() / e) * e,
                            o = document.createElement("script");
                        (o.type = "text/javascript"),
                        (o.async = !0),
                        (o.crossorigin = "anonymous"),
                        (o.src = "https://js.driftt.com/include/" + n + "/" + t + ".js");
                        var i = document.getElementsByTagName("script")[0];
                        i.parentNode.insertBefore(o, i);
                    });
            }
        })();
        drift.SNIPPET_VERSION = "0.3.1";
        drift.load("6ashbsefxhx7");
    </script>
    <!-- End of Async Drift Code -->
    <!-- ***** App Screenshots Area End *****====== -->
    <script>
        (function(i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
                i[r] ||
                function() {
                    (i[r].q = i[r].q || []).push(arguments);
                }),
            (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
        })(window, document, "script", "https://www.google-analytics.com/analytics.js", "ga");

        ga("create", "UA-96096445-4", "auto");
        ga("send", "pageview");
    </script>
    <!-- Go to www.addthis.com/dashboard to customize your tools -->
    <!-- <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-58d9fa1af7a79649"></script> -->
    <!-- Jquery-2.2.4 JS -->
    <script src="../../js/jquery-2.2.4.min.js"></script>
    <!-- Headroom js -->
    <script src="../../js/headroom.js"></script>
    <!-- Popper js -->
    <!-- <script src="../../js/popper.min.js"></script> -->
    <!-- Bootstrap-4 Beta JS -->
    <script src="../../js/bootstrap.min.js"></script>
    <!-- All Plugins JS -->
    <script src="j../../js/plugins.js"></script>
    <!-- Active JS -->
    <script src="../../js/active.js"></script>
    <!-- Resource jQuery -->
    <script src="../../js/jquery.mobile.custom.min.js"></script>
    <!-- Resource jQuery -->
    <script src="../../js/main.js"></script>

    <script src="../../app-assets/vendors/js/vendors.min.js"></script>
    <script src="../../app-assets/fonts/LivIconsEvo/js/LivIconsEvo.tools.js"></script>
    <script src="../../app-assets/fonts/LivIconsEvo/js/LivIconsEvo.defaults.js"></script>
    <script src="../../app-assets/fonts/LivIconsEvo/js/LivIconsEvo.min.js"></script>
    <!-- BEGIN Vendor JS-->

    <!-- BEGIN: Page Vendor JS-->
    <script src="./app-assets/vendors/js/ui/jquery.sticky.js"></script>
    <!-- END: Page Vendor JS-->

    <!-- BEGIN: Theme JS-->
    <script src="../../app-assets/js/scripts/configs/horizontal-menu.js"></script>
    <script src="../../app-assets/js/core/app-menu.js"></script>
    <script src="../../app-assets/js/core/app.js"></script>
    <script src="../../app-assets/js/scripts/components.js"></script>
    <script src="../../app-assets/js/scripts/footer.js"></script>
    <script src="../../js/globalFuntions.js"></script>
    <!-- END: Theme JS-->
    <!-- Headroom -->
    <script>
        $('#navbar-container').load('../components/navbar.html');
        $(document).ready(function() {
            var year = new Date().getFullYear();
            $(".year").text(year);
                         // grab an element
            var myElement = document.querySelector("header");
            // construct an instance of Headroom, passing the element
            var headroom = new Headroom(myElement);
            // initialise
            headroom.init();
        });

        $(document).ready(function() {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script> 
    <script>
    var myHeaders = new Headers();
    var userData = {};
    var nonFilteredReports =[];
    var leftFilteredReports = [];
    var dateFilteredReports = [];
    var activeFilteredReports = [];
    var authRequestOptions = {
        method : "POST",
        redirect : "follow",
        headers : myHeaders,
        body : ""
    }
    fetch("../../ws/auth.php",authRequestOptions)
    .then(response => response.json())
    .then(result => {
        console.log(result);
        userData = result;
    })
    .catch(error =>{console.log(error);});
    auth();
    function loadLeftMenu(){
        var menuContainer = document.getElementById('menuContainer');
        var leftData = {
            load : "loadbyparent",
            id : "leftmenu"
        };
        leftData = JSON.stringify(leftData);
        var leftRequestOptions = {
            method : "POST",
            redirect : "follow",
            headers : myHeaders,
            body : leftData
        }
        fetch("../../ws/Accessconfig.php",leftRequestOptions)
        .then(response => response.json())
        .then(result => {
            console.log(result);
            if(Array.isArray(result)){
                var options = "";
                result.forEach(item =>{
                    if(item.status == "0"){
                        return
                    }
                    options += `<div class="row m-2 ">
                                    <div class="radio">
                                        <input type="radio" class="bg-white left-item" id="`+item.ContentName+`"  value="`+item.ContentName+`" name="left-item">
                                        <label " for="`+item.ContentName+`"><h5 class="text-bold-500 text-white">`+item.ContentName+`</h5></label>
                                    </div>
                                </div>`
                })
                menuContainer.innerHTML = options;
            }
        })
        .then(()=>{
            //get all left menu values
            //get the active one value and add it to btn
            var options = document.querySelectorAll('.left-item');
            options = Array.from(options);
            console.log(options);
            options.forEach(option =>{
                option.addEventListener('click', ()=>{
                    var btn = ``;
                    var newbtn = document.getElementById('newbtn');
                    if(option.checked){
                        // console.log(option.value);
                        btn = `<a href="./expenditureForm.html?action=add&leftmenu=`+option.value+`">
                                            <button type="button" class="btn btn-info mr-1" id="leftmenuvalue">
                                                <i class="bx bx-plus">
                                                
                                                </i>
                                                Add `+option.value+`
                                            </button>
                                </a>`;
                        newbtn.innerHTML = btn; 
                    }
                })
                
            });
            
        })
        .then(()=>{
            loadReports();
        })
        .catch(error =>{console.log(error);});

    }
    
    // loadEmptyState();
    loadLeftMenu();
    function loadReports(){
        //call this function after left menu is loaded  
        var data = {
            load : "loadall"
        }
        data = JSON.stringify(data);
        var requestOption = { method: 'POST', headers: myHeaders,redirect: 'follow',body : data};
        fetch("../../ws/reports.php", requestOption )
        .then(response => response.json())
        .then(result => {
            console.log(result);
            if(Array.isArray(result)){
               nonFilteredReports = result;
               globalFilters();
            }
        })
        .catch(error =>{console.log(error);});
    }
    function nodoc(){
        alert('document is not uploaded');
    }
    function changeStatus(id){
        var status = 1;
        var element = document.getElementById(`active-`+id);
        var data = {
            "load": "changestatus",
            "id" : id,
            "status" : status
        }
        data = JSON.stringify(data);
        var requestOption = { method: 'POST', headers: myHeaders,redirect: 'follow',body : data};
        fetch("../../ws/reports.php", requestOption )
        .then(response => response.json())
        .then(result => {
            console.log(result);
            if(result.code == "200"){
                colorChange();
                toast("updated status","bg-success");
            }
            // alert("status updated");
        }).catch(error =>{
            toast("unable to update status","bg-danger");
            console.log(error);
        });
        function colorChange(){
            console.log("called color change")
            if(element.classList.contains('primary')){
                element.classList.remove('primary');
                status = 0;
            }else{
                element.classList.add('primary');
                status = 1;
            }
        }
    }
    function leftFilter(leftmenuid){
        console.log(leftmenuid);
        //called when left menu data is changed
        //takes left menu id as argument
        //filters non filtered list according to left menu id and updates filtered list
        //show reports give arg filtered list
        var result = nonFilteredReports.filter(report =>{
            return(
                report.leftmenuid == leftmenuid
            );
        })
        console.log(result);
        leftFilteredReports = result;
        dateFilteredReports = leftFilteredReports;
        showReports(leftFilteredReports);
    }
    function dateFilter(date){
        //called when date is changed
        //operates on filtered values
        var result = leftFilteredReports.filter(report =>{
            var reportDate = report.createddate.slice(0,7);
            return(
                reportDate == date
            );
        })
        dateFilteredReports = result;
        showReports(dateFilteredReports);
    }
    function activeFilter(status){
        //called when value is changed on drop down
        //operates on top filtered values
        var result = dateFilteredReports.filter(report =>{
            return(
                report.status == status
            );
        })
        activeFilteredReports = result;
        showReports(activeFilteredReports);
    }
    function globalFilters(){
        //admin filter
        if(userData.admin == "0"){
            var result = [];
            result = nonFilteredReports.filter(report =>{
                    return (
                        report.admin != "1" 
                    );
            })
            nonFilteredReports = result;
        }
        var data = {
            load : "loadmemgroups",
            id : userData.memberId
        }
        data = JSON.stringify(data);
        var requestOption = { method: 'POST', headers: myHeaders,redirect: 'follow',body : data};
        fetch("../../ws/Memberprofile.php", requestOption )
        .then(response => response.json()).
        then(result => {
            console.log(result);
            var userGroups = [];
            if(Array.isArray(result)){
                for(var i in result){
                    userGroups[i] = result[i].ContentName;
                }
                console.log(userGroups);
                result = nonFilteredReports.filter(report =>{
                    var reportGroups = report.visibility.split(',');
                    console.log(reportGroups);
                    var flag = false;
                    reportGroups.forEach(group=>{
                        if(userGroups.includes(group)){
                            flag = true;
                        }
                    })
                    return flag;
                })
                if(userData.admin == "0"){
                    nonFilteredReports = result;
                }
                console.log(result);
                //add event listener for left filter
                var leftItems = document.querySelectorAll('.left-item');
                leftItems = Array.from(leftItems);
                leftItems.forEach(item =>{
                    item.addEventListener('click',()=>{
                        if(item.checked){
                            leftFilter(item.value);
                        }
                    })
                });
                document.querySelector('.left-item').click();
                //date filter
                var date = document.getElementById('date');
                date.addEventListener('change',()=>{
                    console.log("change");
                    dateFilter(date.value);
                });
                //active filter
                var active = document.getElementById('active');
                active.addEventListener('click',()=>{
                    var status = (active.value == "Active") ? "1" : "0";
                    activeFilter(status);
                })
                // showReports(nonFilteredReports);
                
            }else{
                alert('You must be in atleast one group to view reports');
                window.location = './dashBoard.html';
            }
        }).catch(error =>{console.log(error);});
        
    }
    function showReports(reports){
        console.log(reports);
        var reportCards = document.querySelector('.report-cards');
        if(reports.length > 0){
            // load profiles
            var cardHtml = "";
            reports.forEach(report =>{
                var adminIcon = "";
                var active = "primary";
                if(report.document == ""){
                    report.document = "javascript:nodoc()";
                }
                if(report.admin == "1"){
                            
                    adminIcon = `<div class="col">
                        <span class="material-icons info">
                                                security
                                            </span>
                        </div>`;
                }else{
                    report.admin = "";
                }
                if(report.status == "0"){
                    active = "";
                }
                cardHtml += `<div class="card">
                        <div class="row card-body align-items-center">
                            <div class="col">
                                <h6 class="text-bold-500 primary">
                                `+report.Name+`
                                </h6>
                            </div>
                            <div class="col">
                                <div class="row chip-warning chip">
                                <div class="avatar bg-warning">
                                    <span class="material-icons " style="font-size: 1rem; padding-top:0.2rem">
                                        calendar_today
                                    </span>
                                </div>
                                <div class="chip-body">
                                    <span class="chip-text" style="font-size: 1rem; padding: .4rem;">
                                        `+report.createddate+`
                                    </span>
                                </div>
                            </div>
                            </div>
                            <div class="col text-center">
                                <label style="font-weight:bold">Created by</label>
                                <br/>
                                `+report.createdby+`
                            </div>
                            <div class="col-3">
                                <div class="row">
                                `+adminIcon+`  
                                    <div class="col">
                                        <a href="`+report.document+`" target="_blank">
                                            <span class="material-icons">
                                                download
                                            </span>
                                            <span class="material-icons"  style="display: none;">
                                                visibility_off 
                                            </span>
                                        </a>
                                        
                                    </div>
                                    <div class="col">
                                            <span class="material-icons `+active+`" id="active-`+report.id+`" onclick="changeStatus(`+report.id+`)">
                                                thumb_up
                                            </span>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            reportCards.innerHTML = cardHtml;
        }else{
            //load empty state
            empty(reportCards);
        }
    }
    async function empty(section){
        var options = document.querySelectorAll('.left-item');
        options = Array.from(options);
        var type;
        options.forEach(option =>{
            if(option.checked){
                type = option.value;
            }
        })
        section.innerHTML = "";
        var template = document.createElement('div');
        template.innerHTML = `<div class="row justify-content-center">
                                <div class="col-8">
                                    <div class="row justify-content-center">
                                        <h4 class="text-bold-500 text-center">There is no `+type+` reports that have been updated here</h4>
                                    </div>
                                    <div class="row justify-content-center">
                                        <img src="#" id="emptyImage" alt="" style="width:80%">
                                    </div>
                                    
                                </div>
                            </div>`;
        template = await emptyState(template,"Reports");
        section.appendChild(template);
    }
    </script>
</body>

</html>